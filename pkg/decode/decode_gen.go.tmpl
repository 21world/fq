// Code below generated from scalar_gen.go.tmpl
package decode

import (
	"errors"

	"github.com/wader/fq/pkg/bitio"
	"github.com/wader/fq/pkg/scalar"
)

{{- range $name, $t := $.types }}
	// Type {{$name}}

	// TryField{{$name}}ScalarFn tries to add a field, calls scalar functions and returns actual value as a {{$name}}
	func (d *D) TryField{{$name}}ScalarFn(name string, fn func(d *D) (scalar.S, error), sms ...scalar.Mapper) ({{$t.go_type}}, error) {
		v, err := d.TryFieldScalar(name, func(_ scalar.S) (scalar.S, error) { return fn(d) }, sms...)
		if err != nil {
			return {{$t.zero}}, err
		}
		return v.Actual{{$name}}(), err
	}

	// Field{{$name}}ScalarFn adds a field, calls scalar functions and returns actual value as a {{$name}}
	func (d *D) Field{{$name}}ScalarFn(name string, fn func(d *D) scalar.S, sms ...scalar.Mapper) {{$t.go_type}} {
		v, err := d.TryFieldScalar(name, func(_ scalar.S) (scalar.S, error) { return fn(d), nil }, sms...)
		if err != nil {
			panic(IOError{Err: err, Name: name, Op: "{{$name}}", Pos: d.Pos()})
		}
		return v.Actual{{$name}}()
	}

	// Field{{$name}}Fn adds a field, calls {{$t.go_type}} decode function and returns actual value as a {{$name}}
	func (d *D) Field{{$name}}Fn(name string, fn func(d *D) {{$t.go_type}}, sms ...scalar.Mapper) {{$t.go_type}} {
		return d.Field{{$name}}ScalarFn(name, func(d *D) scalar.S { return scalar.S{Actual: fn(d) } }, sms...)
	}

	// TryField{{$name}}Fn tries to add a field, calls {{$t.go_type}} decode function and returns actual value as a {{$name}}
	func (d *D) TryField{{$name}}Fn(name string, fn func(d *D) ({{$t.go_type}}, error), sms ...scalar.Mapper) ({{$t.go_type}}, error) {
		return d.TryField{{$name}}ScalarFn(name, func(d *D) (scalar.S, error) {
			v, err := fn(d)
			return scalar.S{Actual: v}, err
		}, sms...)
	}

	// TryFieldScalar{{$name}}Fn tries to add a field, calls {{$t.go_type}} decode function and returns scalar
	func (d *D) TryFieldScalar{{$name}}Fn(name string, fn func(d *D) ({{$t.go_type}}, error), sms ...scalar.Mapper) (scalar.S, error) {
		return d.TryFieldScalar(name, func(_ scalar.S) (scalar.S, error) {
			v, err := fn(d)
			return scalar.S{Actual: v}, err
		}, sms...)
	}

	// FieldScalar{{$name}}Fn tries to add a field, calls {{$t.go_type}} decode function and returns scalar
	func (d *D) FieldScalar{{$name}}Fn(name string, fn func(d *D) {{$t.go_type}}, sms ...scalar.Mapper) scalar.S {
		v, err := d.TryFieldScalar{{$name}}Fn(name, func(d *D) ({{$t.go_type}}, error) { return fn(d), nil }, sms...)
		if err != nil {
			panic(IOError{Err: err, Name: name, Op: "{{$name}}", Pos: d.Pos()})
		}
		return v
	}
{{end}}

{{- range $name, $t := $.types }}
	{{- if $t.compare}}
		// Validate/Assert {{$name}}

		func assert{{$name}}(s scalar.S, isAssert bool, vs ...{{$t.go_type}}) (scalar.S, error) {
			a := s.Actual{{$name}}()
			for _, b := range vs {
				if {{$t.compare}} {
					s.Description = "valid"
					return s, nil
				}
			}
			s.Description = "invalid"
			if isAssert {
				return s, errors.New("failed to assert {{$name}}")
			}
			return s, nil
		}

		// Assert{{$name}} asserts that actual value is one of given {{$t.go_type}} values
		func (d *D) Assert{{$name}}(vs ...{{$t.go_type}}) scalar.Mapper {
			return scalar.Fn(func(s scalar.S) (scalar.S, error) { return assert{{$name}}(s, !d.Options.Force, vs...) })
		}

		// Validate{{$name}} validates that actual value is one of given {{$t.go_type}} values
		func (d *D) Validate{{$name}}(vs ...{{$t.go_type}}) scalar.Mapper {
			return scalar.Fn(func(s scalar.S) (scalar.S, error) { return assert{{$name}}(s, false, vs...) })
		}
	{{- end}}
{{- end}}

{{- range $r := $.readers }}
	{{- $t := index $.types $r.type }}

	{{- range $v := $r.variants }}
		{{- $range_start := 1 }}
		{{- $range_stop := 1 }}
		{{- if $v.range }}
			{{- $range_start = index $v.range 0 }}
			{{- $range_stop = index $v.range 1 }}
		{{- end}}

		{{- range $n := xrange $range_start $range_stop }}

			// Reader {{$r.name}}{{replace $v.name "$n" $n}}

			// Try{{$r.name}}{{replace $v.name "$n" $n}} tries to read {{replace $v.doc "$n" $n}}
			func (d *D) Try{{$r.name}}{{replace $v.name "$n" $n}}({{$v.params}}) ({{$t.go_type}}, error) { return {{replace $v.call "$n" $n}} }

			// {{$r.name}}{{replace $v.name "$n" $n}} reads {{replace $v.doc "$n" $n}}
			func (d *D) {{$r.name}}{{replace $v.name "$n" $n}}({{$v.params}}) {{$t.go_type}} {
				v, err := {{replace $v.call "$n" $n}}
				if err != nil {
					panic(IOError{Err: err, Op: "{{$r.name}}{{replace $v.name "$n" $n}}", Pos: d.Pos()})
				}
				return v
			}

			// TryField{{$r.name}}{{replace $v.name "$n" $n}} tries to add a field and read {{replace $v.doc "$n" $n}}
			func (d *D) TryField{{$r.name}}{{replace $v.name "$n" $n}}(name string{{if $v.params}}, {{$v.params}}{{end}}, sms ...scalar.Mapper) ({{$t.go_type}}, error) {
				{{- if $v.params}}
					v, err := d.TryFieldScalar(name, func(s scalar.S) (scalar.S, error) {
						v, err := {{replace $v.call "$n" $n}}
						s.Actual = v
						return s, err
					}, sms...)
					if err != nil {
						return {{$t.zero}}, err
					}
					return v.Actual{{$r.type}}(), err
				{{- else}}
					return d.TryField{{$r.type}}Fn(name, (*D).Try{{$r.name}}{{replace $v.name "$n" $n}}, sms...)
				{{- end}}
			}

			// Field{{$r.name}}{{replace $v.name "$n" $n}} adds a field and reads {{replace $v.doc "$n" $n}}
			func (d *D) Field{{$r.name}}{{replace $v.name "$n" $n}}(name string{{if $v.params}}, {{$v.params}}{{end}}, sms ...scalar.Mapper) {{$t.go_type}} {
				{{- if $v.params}}
					v, err := d.TryField{{$r.name}}{{replace $v.name "$n" $n}}(name{{if $v.args}}, {{$v.args}}{{end}}, sms...)
					if err != nil {
						panic(IOError{Err: err, Name: name, Op: "{{$r.name}}{{replace $v.name "$n" $n}}", Pos: d.Pos()})
					}
					return v
				{{- else}}
					return d.Field{{$r.type}}Fn(name, (*D).{{$r.name}}{{replace $v.name "$n" $n}}, sms...)
				{{- end}}
			}
		{{- end}}
	{{- end}}
{{- end}}
